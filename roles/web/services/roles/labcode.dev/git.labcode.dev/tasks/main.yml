---
- name: Create /volume/docker/labcode.dev/git.labcode.dev/gitea/conf directory
  file:
    path: '/volume/docker/labcode.dev/git.labcode.dev/gitea/conf'
    state: directory
    recurse: yes

- name: Add Gitea configuration file
  template:
    src: conf_app.ini.j2
    dest: /volume/docker/labcode.dev/git.labcode.dev/gitea/conf/app.ini

- name: Create/launch docker container git.labcode.dev-app
  docker_container:
    image: gitea/gitea:1
    name: git.labcode.dev-app
    restart_policy: always
    volumes:
      - /volume/docker/labcode.dev/git.labcode.dev:/data
    ports:
      - 22:22
    labels:
      traefik.enable: "true"
      traefik.http.routers.git-labcode-dev_http.rule: "Host(`git.labcode.dev`) || Host(`git.lbcd.dev`) || Host(`git.labcode.de`)"
      traefik.http.routers.git-labcode-dev_http.entryPoints: "http"
      traefik.http.routers.git-labcode-dev_http.middlewares: "https_redirect@file"
      traefik.http.routers.git-labcode-dev_https.rule: "Host(`git.labcode.dev`) || Host(`git.lbcd.dev`) || Host(`git.labcode.de`)"
      traefik.http.routers.git-labcode-dev_https.entryPoints: "https"
      traefik.http.routers.git-labcode-dev_https.tls.certresolver: "le_tls"
      traefik.http.services.git-labcode-dev-app.loadbalancer.server.port: "3000"

- name: Import git.labcode.dev backup
  include_tasks: backup.yml