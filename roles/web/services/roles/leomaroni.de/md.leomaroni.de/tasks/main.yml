---
- name: Create /volume/docker/leomaroni.de/md.leomaroni.de directory
  file:
    path: '/volume/docker/leomaroni.de/md.leomaroni.de'
    state: directory
    recurse: yes

- name: Create/Launch docker container md.leomaroni.de-db
  docker_container:
    image: mariadb:10
    name: md.leomaroni.de-db
    restart_policy: always
    env:
      MYSQL_USER: "{{ hackmd_db_user }}"
      MYSQL_PASSWORD: "{{ hackmd_db_password }}"
      MYSQL_DATABASE: "{{ hackmd_db_database }}"
      MYSQL_ROOT_PASSWORD: "{{ hackmd_db_root_password }}"
    volumes:
      - /volume/docker/leomaroni.de/md.leomaroni.de/db-data:/var/lib/mysql
      - ./resources/utf8.cnf:/etc/mysql/conf.d/utf8.cnf

- name: Create/launch docker container md.leomaroni.de-app
  docker_container:
    image: hackmdio/hackmd:alpine
    name: md.leomaroni.de-app
    restart_policy: always
    links:
      - md.leomaroni.de-db:db
    env:
      HMD_DB_URL: "mysql://{{ hackmd_db_user }}:{{ hackmd_db_password }}@db:3306/{{ hackmd_db_database }}"
    labels:
      traefik.enable: "true"
      traefik.http.routers.md-leomaroni-de_http.rule: "Host(`md.leomaroni.de`)"
      traefik.http.routers.md-leomaroni-de_http.entryPoints: "http"
      traefik.http.routers.md-leomaroni-de_http.middlewares: "https_redirect@file"
      traefik.http.routers.md-leomaroni-de_https.rule: "Host(`md.leomaroni.de`)"
      traefik.http.routers.md-leomaroni-de_https.entryPoints: "https"
      traefik.http.routers.md-leomaroni-de_https.tls.certresolver: "le_tls"