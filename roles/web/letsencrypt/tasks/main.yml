- name: Install certbot, python3 pip, python2/3 setuptools
  apt:
    pkg: ['certbot']
    update_cache: true
    state: present

- name: Install certbot-dns-cloudflare
  pip:
    name: ['wheel', 'certbot-dns-cloudflare']
    executable: pip3

- name: Create Cloudflare API key file
  copy:
    dest: "/etc/letsencrypt/dnscloudflare.ini"
    mode: 0600
    content: |
      dns_cloudflare_api_key = {{ cloudflare_api_key }}
      dns_cloudflare_email = {{ cloudflare_email }}

- name: Change Let's Encrypt API to v2
  lineinfile:
    path: /etc/letsencrypt/cli.ini
    line: 'server = https://acme-staging-v02.api.letsencrypt.org/directory'

- name: Generate Certificate for bechilli.de
  shell: certbot certonly -d *.bechilli.de -d bechilli.de --dns-cloudflare --agree-tos --email webmaster@labcode.de -n --dns-cloudflare-credentials /etc/letsencrypt/dnscloudflare.ini
  notify: reload nginx

- name: Generate Certificate for labcode.de
  shell: certbot certonly -d *.labcode.de -d labcode.de --dns-cloudflare --agree-tos --email webmaster@labcode.de -n --dns-cloudflare-credentials /etc/letsencrypt/dnscloudflare.ini
  notify: reload nginx

- name: Generate Certificate for leomaroni.de
  shell: certbot certonly -d *.leomaroni.de -d leomaroni.de --dns-cloudflare --agree-tos --email webmaster@labcode.de -n --dns-cloudflare-credentials /etc/letsencrypt/dnscloudflare.ini
  notify: reload nginx

- name: Generate Certificate for opendatamap.net
  shell: certbot certonly -d *.opendatamap.net -d opendatamap.net --dns-cloudflare --agree-tos --email webmaster@labcode.de -n --dns-cloudflare-credentials /etc/letsencrypt/dnscloudflare.ini
  notify: reload nginx

- name: remove certbot standard cronjob
  file:
    path: /etc/cron.d/certbot
    state: absent

- name: Add Cronjob doe renewing certificates every month
  cron:
    name: renew letsencrypt certs
    special_time: monthly
    job: "/usr/bin/env certbot renew --post-hook 'systemctl restart nginx'"
    user: root


- name: Add dhparam key by mozilla
  get_url:
    url: https://ssl-config.mozilla.org/ffdhe2048.txt
    dest: /etc/ssl/private/dhparam.pem