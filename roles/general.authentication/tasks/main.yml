---
# tasks file for lbcd.authentication

- name: Disable password based sudo for users in group sudo and enable password less sudo
  lineinfile:
    dest: "/etc/sudoers"
    regexp: '^%sudo'
    line: "%sudo ALL=(ALL) NOPASSWD: ALL"
    validate: 'visudo -cf %s'

- name: Update SSH configuration
  replace: >
    dest=/etc/ssh/sshd_config
    regexp="^([\#\s]*)?{{item.key}}\s+([\w_-]+)"
    replace="{{item.key}} {{item.value}}"
    backup=yes
  with_items:
  - key: PermitRootLogin
    value: 'no'
  - key: PasswordAuthentication
    value: 'no'
  - key: ChallengeResponseAuthentication
    value: 'no'
  - key: PrintLastLog
    value: 'no'
  - key: Port
    value: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36396262393631363738396235343139616435353937623566663939316562323737383134616162
      3231353239323766363830323766333631613066396164640a383637383863656464396361633731
      64346237393433346135303161636431386162323634313263313939313730636162346132353465
      3765616165363663340a376465303762363531313032343639353832616263623032356562336435
      3166

  notify:
  - reload ssh
