---
- stat:
    path: /var/www/leomaroni.de/cloud.leomaroni.de
  register: nextcloud_directory

- set_fact:
    nextcloud_installed: "{{ nextcloud_directory.stat.exists | default(false) }}"

- name: Create /var/www/leomaroni.de/cloud.leomaroni.de directory
  file:
    path: "/var/www/leomaroni.de/cloud.leomaroni.de"
    state: directory
    recurse: yes
  when: not nextcloud_installed

- name: Download nextcloud installation package
  get_url:
    url: "https://download.nextcloud.com/server/releases/nextcloud-18.0.3.zip"
    dest: "/tmp/nextcloud.zip"
    checksum: "sha256:https://download.nextcloud.com/server/releases/nextcloud-18.0.3.zip.sha256"
  when: not nextcloud_installed

- name: Create /tmp/nextcloud directory
  file:
    path: "/var/www/leomaroni.de/cloud.leomaroni.de"
    state: directory
    recurse: yes
  when: not nextcloud_installed

- name: Extract nextcloud installation package
  unarchive:
    src: "/tmp/nextcloud.zip"
    remote_src: yes
    dest: "/var/www/leomaroni.de/cloud.leomaroni.de"
    owner: www-data
    group: www-data
  when: not nextcloud_installed

- name: Delete nextcloud installation package
  file:
    path: "/tmp/nextcloud.zip"
    state: absent
  when: not nextcloud_installed

- name: Add nextcloud cron job
  cron:
    name: "Nextcloud background jobs"
    minute: "*/5"
    job: "php -f /var/www/leomaroni.de/cloud.leomaroni.de/nextcloud/cron.php"
    user: "www-data"
